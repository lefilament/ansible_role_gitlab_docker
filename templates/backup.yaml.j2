version: "2.1"
services:
    backup_gitlab:
        build:
            context: .
            dockerfile: Dockerfile-postgres
        image: filament/duplicity:postgres
        hostname: backup-gitlab
        domainname: "{{ git_url }}"
        environment:
            DST: "swift://gitlab_{{ inventory_hostname|lower }}"
            PGDATABASE: "none"
            PGPASSWORD: "none"
            PGUSER: "none"
            PASSPHRASE: "{{ srv_proxy_pass }}"
            SWIFT_USERNAME: "{{ swift_cloud_username }}"
            SWIFT_PASSWORD: "{{ swift_cloud_password }}"
            SWIFT_AUTHURL: "{{ swift_cloud_authurl }}"
            SWIFT_AUTHVERSION: {{ swift_cloud_authversion }}
            SWIFT_TENANTNAME: "{{ swift_cloud_tenantname }}"
            SWIFT_TENANTID: "{{ swift_cloud_tenantid }}"
            SWIFT_REGIONNAME: "{{ swift_cloud_regionname }}"
            JOB_200_WHEN: "never"
            JOB_300_WHAT: "backup --full-if-older-than 1D"
            JOB_302_WHAT: "dup remove-all-but-n-full 30 --force $$DST $$@"
            JOB_302_WHEN: "daily"
        command:
            - /etc/periodic/daily/jobrunner
        volumes:
            - gitlab_config:/mnt/backup/src/config:z
            - /var/lib/docker/volumes/gitlab_data/_data/backups/:/mnt/backup/src/data_backups:z

volumes:
    gitlab_config:
        external: true
